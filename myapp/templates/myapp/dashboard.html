{% extends "base.html" %}
{% load static custom_filters i18n %}

{% block html_title  %}Dashboard - {{ subscription.name }}{% endblock %}
{% block scripts %}
<script>
    document.getElementById("exportDropdownButton").addEventListener("click", function () {
        const menu = document.querySelector(".dropdown-menu");
        menu.classList.toggle("hidden");
    });

    // Close the dropdown when clicking outside
    window.addEventListener("click", function (event) {
        const menu = document.querySelector(".dropdown-menu");
        const button = document.getElementById("exportDropdownButton");

        if (!button.contains(event.target) && !menu.contains(event.target)) {
            menu.classList.add("hidden");
        }
    });
</script>

{% endblock %}
{% block title  %}
    <a href="{% url "admin:myapp_subscription_changelist" %}">
        <h1 class="text-2xl font-bold">
        {{ "Dashboard " }}{{ subscription.name }}
        </h1>
    </a>
    <a href="{% url 'admin:index' %}">
        {# https://lucide.dev/icons/settings #}
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
    </a>
{% endblock %}
{% block content  %}

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-slate-500 text-sm font-medium">{% translate "Total Subscriptions" %}</h3>
                <p class="text-2xl font-bold text-slate-800 mt-2">{{ stats.total_subscriptions }}</p>
                <p class="text-sm {% if stats.subscription_growth >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                    {% if stats.subscription_growth >= 0 %}↑{% else %}↓{% endif %}
                    {{ stats.subscription_growth|floatformat:0 }}{{ "%" }}
                    {% with last=stats.total_subscriptions_last_year  %}
                        {% blocktrans %}(last year {{ last }}){% endblocktrans %}
                    {% endwith %}
                </p>
            </div>

            <!-- Due Amount -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-slate-500 text-sm font-medium">{% translate "Due Amount" %}</h3>
                <p class="text-2xl font-bold text-slate-800 mt-2">{{ stats.due_amount|format_price }}</p>
                <p class="text-sm {% if stats.due_amount_growth <= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                    {% if stats.due_amount_growth <= 0 %}↓{% else %}↑{% endif %}
                    {{ stats.due_amount_growth|floatformat:0 }}{{ "%" }}
                        {% with last=stats.last_year_due_amount|format_price  %}
                            {% blocktrans %}(last year {{ last }}){% endblocktrans %}
                        {% endwith %}
                </p>
            </div>

            <!-- Paid Amount -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-slate-500 text-sm font-medium">{% translate "Paid Amount" %}</h3>
                <p class="text-2xl font-bold text-slate-800 mt-2">{{ stats.paid_amount|format_price }}</p>
                <p class="text-sm {% if stats.collection_rate == 100 %}text-green-500{% else %}text-red-500{% endif %}">
                    {% if stats.collection_rate == 100 %}↑{% elif status.collection_rate > 0 %}↓{% endif %}
                    {% with rate=stats.collection_rate|floatformat:0  %}
                        {% blocktrans %}{{ rate }}% collection rate{% endblocktrans %}
                    {% endwith %}
                </p>
            </div>

            <!-- Active Users -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-slate-500 text-sm font-medium">{% translate "Active Users" %}</h3>
                <p class="text-2xl font-bold text-slate-800 mt-2">{{ stats.active_users }}</p>
                <p class="text-sm {% if stats.retention_rate >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                    {% if stats.retention_rate >= 0 and stats.retention_rate != 100 %}↑{% elif stats.retention_rate < 100 %}↓{% endif %}
                    {% with total_users=stats.total_users  %}
                        {% with rate=stats.retention_rate|floatformat:0 %}
                            {% blocktrans %}{{ rate }}% retention ({{ total_users}}){% endblocktrans %}
                        {% endwith %}
                    {% endwith %}
                </p>
            </div>
        </div>

        <!-- Subscription Table -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">{% translate "Subscriptions" %}</h2>
{#                    <a href="{% url 'admin:subscriptions_subscription_add' %}"#}
{#                       class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">#}
{#                        Add Subscription#}
{#                    </a>#}
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-slate-50">
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">{% translate "column.Member(s)" %}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">{% translate "column.Amount" %}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">{% translate "column.Invoices" %}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">{% translate "column.Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200">
                            {% for member_subscription in member_subscriptions %}
                                <tr class="hover:bg-slate-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800">
                                        {{ member_subscription.member.firstname|default:"" }} {{ member_subscription.member.lastname|default:""  }}
                                        {% for child in member_subscription.children.all %}
                                            {{ "&" }}
                                            {{ child.member.get_fullname  }}
                                        {% endfor %}
                                        {% with count=member_subscription.parent_count|add:1 %}
                                            ({{ count }})
                                        {% endwith %}
                                    </td>
                                    {% with open_balance=member_subscription.has_due_balance %}
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-800 {% if open_balance %}bg-red-100 text-red-800{% endif %}">
                                            {{ member_subscription.get_paid_amount|format_price }}{{ " / " }}{{ member_subscription.get_price|format_price }}
                                        </td>
                                    {% endwith %}
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {%  if member_subscription.invoice_count > 0 %}
                                            <ul>
                                        {% for invoice in member_subscription.invoices.all %}
                                            <li>
                                            {{ invoice.price|format_price }}
                                            {% if invoice.status.lower == InvoiceStatusEnum.PAID %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                    {{ invoice.get_status_text }}
                                                </span>
                                            {% elif invoice.status.lower == InvoiceStatusEnum.CANCELED.lower %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                                    {{ invoice.get_status_text }}
                                                </span>
                                            {% elif invoice.status.lower == InvoiceStatusEnum.PENDING.lower %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                    {{ invoice.get_status_text }}
                                                </span>
                                            {% elif invoice.status.lower == InvoiceStatusEnum.CREATED.lower %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                    {{ invoice.get_status_text }}
                                                </span>
                                            {% else %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                    {{ invoice.get_status_text }}
                                                </span>
                                            {% endif %}
                                            </li>
                                        {% endfor %}
                                            </ul>
                                        {% else %}
                                            {{ "-" }}{# invoice_count = 0 #}
                                        {% endif %}

                                    </td>
                                    <td colspan="5" class="px-6 py-4 text-center text-sm text-slate-500">
                                        <a href="{% url "admin:myapp_membersubscription_changelist" %}?id={{ member_subscription.pk }}" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition inline-block">
                                            {# https://lucide.dev/icons/pencil  #}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                                <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/><path d="m15 5 4 4"/>
                                            </svg>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-sm text-slate-500">
                                        No subscriptions found
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    <!-- actions buttons -->
<nav class="bg-white shadow-lg shadow rounded-lg gap-6 mb-8">
    <div class="flex justify-evenly items-center p-6">
        <a class="grow m-2 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition" href="#">Todo: Mark created invoices as pending</a>
        <a class="grow m-2 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition" href="#">Todo: Create reminder for pending invoice older than 30 days</a>
        <a class="grow m-2 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition" title="{%  translate 'action.csv_import' %}" href="{% url 'csv_import' %}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-upload">
                <path d="M12 13v8"/><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="m8 17 4-4 4 4"/>
            </svg>
        </a>
        <a class="grow m-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition flex items-center" href="#" title="{% translate "Export created invoices" %}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt">
                <path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/>
                <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/>
                <path d="M12 17.5v-11"/>
            </svg>
            <span>PDF</span>
        </a>

        <!-- Dropdown for Export -->
        <div class="relative inline-block text-left">
            <button type="button" class="flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition" id="exportDropdownButton" aria-expanded="false" aria-haspopup="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" x2="12" y1="15" y2="3"/>
                </svg>
                <span class="ml-2">{% translate "Export list" %}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                    <path d="m6 9 6 6 6-6"/>
                </svg>
            </button>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-10" aria-labelledby="exportDropdownButton">
                <a href="{% url 'subscription_export_with_extension' subscription_name=subscription.name extension='csv' %}" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-lg">{% translate "Export list as CSV" %}</a>
                <a href="{% url 'subscription_export_with_extension' subscription_name=subscription.name extension='xslx' %}" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-lg">{% translate "Export list as XLSX" %}</a>
            </div>
        </div>
    </div>
</nav>



{% endblock %}